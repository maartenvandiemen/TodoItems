jobs:
- job: Deploy_App
  dependsOn: [Create_Env]
  
  variables: 
  - group: AzureSecrets
  - name: appServiceAppName
    value: $[ dependencies.Create_Env.outputs['SaveDeploymentOutputs.appServiceAppName'] ]
  - name: resourceGroupName
    value: $[ dependencies.Generate_ResourcegroupName.outputs['DetermineResourcegroupName.resourcegroupName'] ]

  steps:
  - checkout: none
  - download: current
    artifact: todoItemsAPI
    displayName: Download API
  - powershell: Compress-Archive -Path $(Pipeline.Workspace)/todoItemsAPI -DestinationPath $(Pipeline.Workspace)\todoItemsAPI\api.zip
  - task: AzurePowerShell@5
    inputs:
      azureSubscription: 'Azure'
      ScriptType: 'InlineScript'
      Inline: |
        az webapp deployment source config-zip --src $(Pipeline.Workspace)\todoItemsAPI\api.zip -name $(appServiceAppName) --resource-group $(resourceGroupName)
        az webapp config set --startup-file="dotnet TodoItems.Api.dll"
      azurePowerShellVersion: 'LatestVersion'
      pwsh: true
